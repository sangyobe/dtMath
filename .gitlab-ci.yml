# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence

# image: localhost:5000/ubuntu-cpptests:20.04

stages:
  - build
  - test

# Job name 'build'
build:
# Runs at 'build' stage
  stage: build
  tags:
    - dtMath_CMake_tag_windows
  script:
    - rm -Rf build  # Guarantee that tests and coverage are using latest src and tests
    - mkdir build
    - cd build
    - cmake ..
    - make -j8

# Job name 'test'
test:
  # Runs at 'test' stage
  stage: test
  only:
    - master
  tags:
    - dtMath_CMake_tag_windows
  script:
    - ./bin/test
    - ls -l
    - cd CMakeFiles/test.dir/
    - ls -l
    - lcov -d . -c -o coverage.info
    - lcov -r coverage.info */build/* */tests/* */c++/* -o coverageFiltered.info
    - lcov --list coverageFiltered.info
  coverage: '/Total:\|\s*([0-9.]+%)\s.*$/'
